set(CMSIS_CORE_INCLUDE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/cmsis_core/Include)
set(CMSIS_DEVICE_INCLUDE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/cmsis_device_f1/Include)
set(CMSIS_DEVICE_SOURCE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/cmsis_device_f1/Source)
set(STM32HAL_INCLUDE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/stm32f1xx_hal_driver/Inc)
set(STM32HAL_SOURCE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/stm32f1xx_hal_driver/Src)

file(GLOB_RECURSE HAL_SOURCES CONFIGURE_DEPENDS ${STM32HAL_SOURCE_DIR}/*.c ${STM32HAL_SOURCE_DIR}/*.c)
list(APPEND HAL_SOURCES ${CMSIS_DEVICE_SOURCE_DIR}/Templates/gcc/startup_stm32f103x6.s)
list(APPEND HAL_SOURCES ${CMSIS_DEVICE_SOURCE_DIR}/Templates/system_stm32f1xx.c)
list(FILTER HAL_SOURCES EXCLUDE REGEX ".*_template.c$")

add_library(stm32core INTERFACE)
target_sources(stm32core INTERFACE ${HAL_SOURCES})
target_include_directories(stm32core INTERFACE
  $<BUILD_INTERFACE:${CMSIS_CORE_INCLUDE_DIR}>
  $<BUILD_INTERFACE:${CMSIS_DEVICE_INCLUDE_DIR}>
  $<BUILD_INTERFACE:${STM32HAL_INCLUDE_DIR}>)
